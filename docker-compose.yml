version: '3'

services:
  redis:
    image: redis:alpine
    command: redis-server
    container_name: redis-srv
    ports:
      - 6379:6379
    expose:
      - 6379
    environment:
      - REDIS_REPLICATION_MODE=master

  redis-commander:
    container_name: redis-commander-web
    hostname: redis-commander
    image: rediscommander/redis-commander:latest
    restart: always
    environment:
      - REDIS_HOSTS=local:redis:6379
    ports:
      - "8081:8081"

  node:
    image: trufflesuite/ganache-cli:latest
    ports:
      - "8545:8545"
    volumes:
      - ./ganache_data:/ganache_data
    entrypoint:
      - node
      - /app/ganache-core.docker.cli.js
      - --deterministic
      - --db=/ganache_data
      - --mnemonic
      - 'minimum symptom minute gloom tragic situate silver mechanic salad amused elite beef'
      - --networkId
      - '5777'
      - --hostname
      - '0.0.0.0'
      - --debug

  mq-store-agent:
    build:
      context: .
      dockerfile: Dockerfile
    restart: always
    environment:
      - ETH_PRIVATE_KEY=0x22aabb811efca4e6f4748bd18a46b502fa85549df9fa07da649c0a148d7d5530
    depends_on:
      - redis
      - node
    ports:
      - 8008:8008

  # consumer-one:
  #   container_name: replication-consumer-one
  #   build: '.'
  #   environment:
  #     REDIS_HOST: redis
  #     STREAM: replication
  #     GROUP: replicate-1
  #   depends_on:
  #     - redis
  #   restart: always

  # consumer-two:
  #   container_name: replication-consumer-two
  #   build: '.'
  #   environment:
  #     REDIS_HOST: redis
  #     STREAM: replication
  #     GROUP: replicate-2
  #   depends_on:
  #     - redis
  #   restart: always
